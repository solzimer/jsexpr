{"version":3,"sources":["../../../lib/expression.js"],"names":["extend","require","RX","_val","obj","key","eval","err","undefined","val","v","call","valwalk","src","ops","path","Object","keys","forEach","newpath","k","parse","expr","m","match","token","replace","trim","fn","Function","entry","tokens","JSON","stringify","list","idx","indexOf","t","substring","length","push","map","join","jsontokens","json","walk","op","value","reduce","module","exports","input"],"mappings":"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","file":"expression.js","sourcesContent":["const extend = require(\"extend\");\r\nconst RX = /\\$\\{[^\\}]+\\}/g;\r\n\r\nfunction _val(obj,key) {\r\n\ttry {\r\n\t\treturn eval(`this.${key}`);\r\n\t}catch(err) {\r\n\t\treturn undefined;\r\n\t}\r\n}\r\n\r\nfunction val(obj,key) {\r\n\tvar v = _val.call(obj,obj,key);\r\n\treturn v===undefined? \"\" : v;\r\n}\r\n\r\nfunction valwalk(src,ops,path) {\r\n\tif(!src) return src;\r\n\tObject.keys(src).forEach(k=>{\r\n\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\tif(ops[newpath])\r\n\t\t\tsrc[k] = ops[newpath];\r\n\t\tif(typeof(src[k])==\"object\")\r\n\t\t\tvalwalk(src[k],ops,newpath);\r\n\t});\r\n\treturn src;\r\n}\r\n\r\nfunction parse(expr) {\r\n\tvar m = expr.match(RX);\r\n\tif(m) {\r\n\t\tm.forEach(token=>{\r\n\t\t\tvar key = token.replace(/[\\$\\{\\}]/g,\"\").trim();\r\n\t\t\texpr = expr.replace(token,\"__val(entry,'\"+key+\"')\");\r\n\t\t});\r\n\t}\r\n\tvar fn = new Function(\"entry\",\"__val\",\"return (\"+expr+\")\");\r\n\r\n\treturn function(entry) {\r\n\t\treturn fn(entry,val);\r\n\t}\r\n}\r\n\r\nfunction tokens(expr) {\r\n\tif(expr==\"${JSON}\") return function(entry) {return JSON.stringify(entry,null,2)};\r\n\r\n\tvar list = [];\r\n\tvar m = expr.match(RX)||[];\r\n\tm.forEach(token=>{\r\n\t\tvar idx = expr.indexOf(token);\r\n\t\tvar t = expr.substring(0,idx);\r\n\t\texpr = expr.substring(idx+token.length);\r\n\t\tlist.push(t);\r\n\t\tlist.push(function(entry){\r\n\t\t\treturn val(entry,token.replace(/\\$|\\{|\\}/g,\"\"))\r\n\t\t});\r\n\t});\r\n\tlist.push(expr);\r\n\r\n\treturn function(entry) {\r\n\t\treturn list.map(t=>typeof(t)==\"string\"? t : t(entry)).join(\"\");\r\n\t}\r\n}\r\n\r\nfunction jsontokens(json) {\r\n\tlet ops = [];\r\n\r\n\tfunction walk(json,path) {\r\n\t\tif(!json) return;\r\n\t\tObject.keys(json).forEach(k=>{\r\n\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\tlet t = json[k];\r\n\t\t\tif(typeof(t)==\"string\") {\r\n\t\t\t\tops.push({path:newpath,fn:tokens(t)});\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\twalk(t,newpath);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\twalk(json,\"\");\r\n\r\n\treturn function(entry) {\r\n\t\tlet map = ops.map(op=>{\r\n\t\t\treturn {path:op.path, value:op.fn(entry)}\r\n\t\t}).reduce((map,op)=>{\r\n\t\t\tmap[op.path] = op.value;\r\n\t\t\treturn map;\r\n\t\t},{});\r\n\r\n\t\treturn valwalk(extend(true,{},json),map,\"\");\r\n\t}\r\n}\r\n\r\nmodule.exports = {\r\n\tfn : parse,\r\n\teval : parse,\r\n\texpr(input){\r\n\t\tif(typeof(input)==\"object\")\r\n\t\t\treturn jsontokens(input);\r\n\t\telse\r\n\t\t\treturn tokens(input);\r\n\t}\r\n}\r\n"]}