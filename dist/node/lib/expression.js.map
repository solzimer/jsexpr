{"version":3,"sources":["../../../lib/expression.js"],"names":["extend","require","RX","_val","obj","key","arr","split","forEach","undefined","val","v","valwalk","src","ops","path","Object","keys","newpath","k","parse","expr","m","match","token","replace","trim","fn","Function","entry","tokens","JSON","stringify","list","idx","indexOf","t","substring","length","push","map","join","jsontokens","json","walk","op","value","reduce","module","exports","eval","input"],"mappings":"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","file":"expression.js","sourcesContent":["const extend = require(\"extend\");\r\nconst RX = /\\$\\{[^\\}]+\\}/g;\r\n\r\nfunction _val(obj,key) {\r\n\tvar arr = key.split(\".\");\r\n\tarr.forEach(key=>{\r\n\t\tif(obj==null || obj==undefined) return;\r\n\t\telse obj = obj[key];\r\n\t});\r\n\r\n\treturn obj || undefined;\r\n}\r\n\r\nfunction val(obj,key) {\r\n\tvar v = _val(obj,key);\r\n\treturn v===undefined? \"\" : v;\r\n}\r\n\r\nfunction valwalk(src,ops,path) {\r\n\tif(!src) return src;\r\n\tObject.keys(src).forEach(k=>{\r\n\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\tif(ops[newpath])\r\n\t\t\tsrc[k] = ops[newpath];\r\n\t\tif(typeof(src[k])==\"object\")\r\n\t\t\tvalwalk(src[k],ops,newpath);\r\n\t});\r\n\treturn src;\r\n}\r\n\r\nfunction parse(expr) {\r\n\tvar m = expr.match(RX);\r\n\tif(m) {\r\n\t\tm.forEach(token=>{\r\n\t\t\tvar key = token.replace(/[\\$\\{\\}]/g,\"\").trim();\r\n\t\t\texpr = expr.replace(token,\"__val(entry,'\"+key+\"')\");\r\n\t\t});\r\n\t}\r\n\tvar fn = new Function(\"entry\",\"__val\",\"return (\"+expr+\")\");\r\n\r\n\treturn function(entry) {\r\n\t\treturn fn(entry,val);\r\n\t}\r\n}\r\n\r\nfunction tokens(expr) {\r\n\tif(expr==\"${JSON}\") return function(entry) {return JSON.stringify(entry,null,2)};\r\n\r\n\tvar list = [];\r\n\tvar m = expr.match(RX)||[];\r\n\tm.forEach(token=>{\r\n\t\tvar idx = expr.indexOf(token);\r\n\t\tvar t = expr.substring(0,idx);\r\n\t\texpr = expr.substring(idx+token.length);\r\n\t\tlist.push(t);\r\n\t\tlist.push(function(entry){\r\n\t\t\treturn val(entry,token.replace(/\\$|\\{|\\}/g,\"\"))\r\n\t\t});\r\n\t});\r\n\tlist.push(expr);\r\n\r\n\treturn function(entry) {\r\n\t\treturn list.map(t=>typeof(t)==\"string\"? t : t(entry)).join(\"\");\r\n\t}\r\n}\r\n\r\nfunction jsontokens(json) {\r\n\tlet ops = [];\r\n\r\n\tfunction walk(json,path) {\r\n\t\tif(!json) return;\r\n\t\tObject.keys(json).forEach(k=>{\r\n\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\tlet t = json[k];\r\n\t\t\tif(typeof(t)==\"string\") {\r\n\t\t\t\tops.push({path:newpath,fn:tokens(t)});\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\twalk(t,newpath);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\twalk(json,\"\");\r\n\r\n\treturn function(entry) {\r\n\t\tlet map = ops.map(op=>{\r\n\t\t\treturn {path:op.path, value:op.fn(entry)}\r\n\t\t}).reduce((map,op)=>{\r\n\t\t\tmap[op.path] = op.value;\r\n\t\t\treturn map;\r\n\t\t},{});\r\n\r\n\t\treturn valwalk(extend(true,{},json),map,\"\");\r\n\t}\r\n}\r\n\r\nmodule.exports = {\r\n\tfn : parse,\r\n\teval : parse,\r\n\texpr(input){\r\n\t\tif(typeof(input)==\"object\")\r\n\t\t\treturn jsontokens(input);\r\n\t\telse\r\n\t\t\treturn tokens(input);\r\n\t}\r\n}\r\n"]}