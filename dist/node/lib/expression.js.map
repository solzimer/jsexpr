{"version":3,"sources":["../../../lib/expression.js"],"names":["EVALS","require","extend","dayjs","Mingo","instance","token","RX","RegExp","RX_RPL_PARSE","RX_RPL_TOKEN","RX_FILTER","FILTERS","JSON","args","nexpr","spaces","length","isNaN","parseInt","fnxpr","tokens","entry","stringify","DATE","shift","format","join","split","res","dt","toDate","SUBSTR","start","end","undefined","substring","fnassign","path","npath","map","t","i","fn","console","log","eval","parse","expr","method","m","match","forEach","key","replace","trim","Function","list","len","idx","indexOf","rtoken","push","test","filter","l","ret","jsontokens","json","ops","walk","Object","keys","newpath","k","op","valwalk","mingotokens","xpr","Array","isArray","$","aggr","Aggregator","input","run","exprfn","obj","ninput","prfn","nxfn","prres","nxres","_","traverse","object","callback","name","fncallback","assign","expression","module","exports"],"mappings":"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","file":"expression.js","sourcesContent":["const \r\n\tEVALS = require('./evals.js'), \r\n\textend = require(\"extend\"),\r\n\tdayjs = require('dayjs'),\r\n\tMingo = require(\"mingo\");\r\n\r\nfunction instance(token) {\r\n\tconst RX = new RegExp(`\\\\${token}\\\\{[^\\\\}]+\\\\}`,'g');\r\n\tconst RX_RPL_PARSE = new RegExp(`\\\\${token}\\\\{([^\\\\}]+)\\\\}`);\r\n\tconst RX_RPL_TOKEN = new RegExp(`\\\\${token}\\\\{|\\\\}`,'g');\r\n\tconst RX_FILTER = new RegExp(`^[A-Z_]+\\\\:`);\r\n\r\n\tconst FILTERS = {\r\n\t\tJSON(args) {\r\n\t\t\tlet nexpr = args[1];\r\n\t\t\tlet spaces = args[2];\r\n\t\t\tif(args.length==2) {\r\n\t\t\t\tif(isNaN(nexpr)) {spaces = 2;}\r\n\t\t\t\telse {nexpr = 'this';\tspaces = args[1];}\r\n\t\t\t}\r\n\t\t\telse if(args.length==1) {\r\n\t\t\t\tnexpr = 'this';\r\n\t\t\t\tspaces = 2;\r\n\t\t\t}\r\n\t\t\tspaces = parseInt(spaces);\r\n\t\t\tlet fnxpr = tokens(\"${\"+nexpr+\"}\");\r\n\t\t\treturn function(entry) {\r\n\t\t\t\treturn JSON.stringify(fnxpr(entry),null,spaces);\r\n\t\t\t}\r\n\t\t},\r\n\t\tDATE(args) {\r\n\t\t\targs.shift();\r\n\t\t\tlet nexpr = tokens(\"${\"+args.shift()+\"}\");\r\n\t\t\tlet format = args.join(\":\").split('|');\r\n\t\t\treturn function(entry) {\r\n\t\t\t\tlet res = nexpr(entry);\r\n\t\t\t\tlet dt = dayjs(res,format[0]);\r\n\t\t\t\tif(format[1]) {\r\n\t\t\t\t\treturn dt.format(format[1]);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\treturn dt.toDate();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\tSUBSTR(args) {\r\n\t\t\targs.shift();\r\n\t\t\tlet nexpr = tokens(\"${\"+args.shift()+\"}\");\r\n\t\t\tlet format = args.join(\":\").split('|');\r\n\t\t\tlet start = parseInt(format[0]);\r\n\t\t\tlet end = parseInt(format[1]);\r\n\t\t\tif(isNaN(start)) start = 0;\r\n\t\t\tif(isNaN(end)) end = undefined;\r\n\t\t\treturn function(entry) {\r\n\t\t\t\tlet res = nexpr(entry);\r\n\t\t\t\treturn typeof(res=='string') ? res.substring(start,end) : res;\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\t};\r\n\r\n\tfunction fnassign(path) {\r\n\t\tlet npath = path.split('.').map((t,i)=>\"['\"+t+\"']\").join('');\r\n\r\n\t\tlet fn = `(function(path){\r\n\t\t\treturn function(obj,val) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// Ensure path\r\n\t\t\t\t\tlet root = obj;\r\n\t\t\t\t\tlet kpath = path.split('.');\r\n\t\t\t\t\tfor(let i=0; i<kpath.length;i++) {\r\n\t\t\t\t\t\tlet k = kpath[i];\r\n\t\t\t\t\t\tif(!root[k]) root[k] = {};\r\n\t\t\t\t\t\troot = root[k];\r\n\t\t\t\t\t}\r\n\t\r\n\t\t\t\t\treturn obj${npath} = val;\r\n\t\t\t\t}catch(err) {}\r\n\t\t\t}\r\n\t\t})('${path}')`;\r\n\r\n\t\tconsole.log(fn);\r\n\t\treturn eval(fn);\r\n\t}\r\n\r\n\tfunction parse(expr,method) {\r\n\t\tmethod = method || \"ceval\";\r\n\t\tvar m = expr.match(RX);\r\n\t\tif(m) {\r\n\t\t\tm.forEach(token=>{\r\n\t\t\t\tvar key = token.replace(RX_RPL_PARSE,\"$1\").trim().replace(/'/g,\"\\\\'\");\r\n\t\t\t\texpr = expr.replace(token,\"__val(entry,'\"+key+\"')\");\r\n\t\t\t});\r\n\t\t}\r\n\t\tvar fn = new Function(\"entry\",\"__val\",\"return (\"+expr+\")\");\r\n\r\n\t\treturn function(entry) {\r\n\t\t\treturn fn(entry,EVALS[method]);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction tokens(expr,method) {\r\n\t\tmethod = EVALS[method || \"ceval\"];\r\n\r\n\t\tvar list = [], len = 0;\r\n\t\tvar m = expr.match(RX)||[];\r\n\t\tm.forEach(token=>{\r\n\t\t\tvar idx = expr.indexOf(token);\r\n\t\t\tvar t = expr.substring(0,idx);\r\n\t\t\tvar rtoken = token.replace(RX_RPL_TOKEN,\"\");\r\n\t\t\texpr = expr.substring(idx+token.length);\r\n\t\t\tlist.push(t);\r\n\r\n\t\t\t// Filter\r\n\t\t\tif(RX_FILTER.test(rtoken)) {\r\n\t\t\t\tlet args = rtoken.split(\":\");\r\n\t\t\t\tlet fn = FILTERS[args[0]](args);\r\n\t\t\t\tlist.push(fn);\r\n\t\t\t}\r\n\t\t\t// Evaluator\r\n\t\t\telse {\r\n\t\t\t\tlist.push(function(entry){\t\t\t\t\r\n\t\t\t\t\treturn method(entry,rtoken);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tlist.push(expr);\r\n\t\tlist = list.filter(l=>l!=\"\");\r\n\t\tlen = list.length;\r\n\r\n\t\tif(len>1) {\r\n\t\t\treturn function(entry) {\r\n\t\t\t\tlet ret = \"\";\r\n\t\t\t\tfor(let i=0;i<len;i++) {\r\n\t\t\t\t\tlet t = list[i];\r\n\t\t\t\t\tret += typeof(t)==\"string\"? t : t(entry);\r\n\t\t\t\t}\r\n\t\t\t\treturn ret;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn function(entry) {\r\n\t\t\t\tlet t = list[0];\r\n\t\t\t\tif(typeof(t)=='undefined') return undefined;\r\n\t\t\t\treturn typeof(t)==\"string\"? t : t(entry);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction jsontokens(json) {\r\n\t\tlet ops = [], len = 0;\r\n\r\n\t\tfunction walk(json,path) {\r\n\t\t\tif(!json) return;\r\n\t\t\tObject.keys(json).forEach(k=>{\r\n\t\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\t\tlet t = json[k];\r\n\t\t\t\tif(typeof(t)==\"string\") {\r\n\t\t\t\t\tops.push({path:newpath,fn:tokens(t)});\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\twalk(t,newpath);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\twalk(json,\"\");\r\n\t\tlen = ops.length;\r\n\r\n\t\treturn function(entry) {\r\n\t\t\tlet map = {};\r\n\t\t\tfor(let i=0;i<len;i++) {\r\n\t\t\t\tlet op = ops[i];\r\n\t\t\t\tmap[op.path] = op.fn(entry);\r\n\t\t\t}\r\n\t\t\treturn EVALS.valwalk(extend(true,{},json),map,\"\");\r\n\t\t}\r\n\t}\r\n\r\n\tfunction mingotokens(json) {\r\n\t\tlet xpr = Array.isArray(json.$)? json.$ : [json.$];\r\n\t\tlet aggr = new Mingo.Aggregator(xpr);\r\n\t\treturn function(input) {\r\n\t\t\tlet isArray = Array.isArray(input);\r\n\t\t\tlet res = aggr.run(isArray? input : [input]);\r\n\t\t\tif(!isArray && res.length<=1) return res[0];\r\n\t\t\telse return res;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction exprfn(input,replace){\r\n\t\tif(typeof(input)=='number') {\r\n\t\t\treturn function(obj){return input};\r\n\t\t}\r\n\t\telse if(typeof(input)==\"object\") {\r\n\t\t\tlet ninput = extend({},input);\r\n\t\t\tdelete ninput['$'];\r\n\r\n\t\t\tconst prfn = input[\"$\"] ? mingotokens(input, replace) : (input)=>input;\r\n\t\t\tconst nxfn = Object.keys(ninput).length? jsontokens(ninput,replace) : (input)=>input;\r\n\t\t\t\r\n\t\t\treturn function(obj) {\r\n\t\t\t\tlet prres = prfn(obj);\r\n\t\t\t\tlet nxres = nxfn(prres);\r\n\t\t\t\tif(typeof(nxres._)!=='undefined' && Object.keys(nxres).length==1) \r\n\t\t\t\t\treturn nxres._;\r\n\t\t\t\telse\r\n\t\t\t\t\treturn nxres;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn tokens(input);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction traverse(object,callback) {\r\n\t\tfor(let key in object) {\r\n\t\t\tobject[key] = callback(object,key,object[key]);\r\n\t\t}\r\n\r\n\t\tfor(let key in object) {\r\n\t\t\tif(typeof(object[key])=='object') {\r\n\t\t\t\ttraverse(object[key],callback);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction filter(name, fncallback) {\r\n\t\tFILTERS[name] = fncallback;\r\n\t}\r\n\r\n\treturn {\r\n\t\tfn : parse,\r\n\t\teval : parse,\r\n\t\tassign : fnassign,\r\n\t\texpr : exprfn,\r\n\t\texpression : exprfn,\r\n\t\ttraverse : traverse,\r\n\t\tfilter : filter\r\n\t}\r\n}\r\n\r\nmodule.exports = instance;\r\n"]}