{"version":3,"sources":["../../../lib/expression.js"],"names":["extend","require","RX","_val","obj","key","arr","split","forEach","undefined","val","v","valwalk","src","ops","path","Object","keys","newpath","k","parse","expr","m","match","token","replace","trim","fn","Function","entry","tokens","JSON","stringify","list","idx","indexOf","t","substring","length","push","map","join","jsontokens","json","walk","op","value","reduce","module","exports","input"],"mappings":"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","file":"expression.js","sourcesContent":["const extend = require(\"extend\");\nconst RX = /\\$\\{[^\\}]+\\}/g;\n\nfunction _val(obj,key) {\n\tvar arr = key.split(\".\");\n\tarr.forEach(key=>{\n\t\tif(obj==null || obj==undefined) return;\n\t\telse obj = obj[key];\n\t});\n\n\treturn obj || undefined;\n}\n\nfunction val(obj,key) {\n\tvar v = _val(obj,key);\n\treturn v===undefined? \"\" : v;\n}\n\nfunction valwalk(src,ops,path) {\n\tif(!src) return src;\n\tObject.keys(src).forEach(k=>{\n\t\tlet newpath = `${path}${path?'.':''}${k}`;\n\t\tif(ops[newpath])\n\t\t\tsrc[k] = ops[newpath];\n\t\tif(typeof(src[k])==\"object\")\n\t\t\tvalwalk(src[k],ops,newpath);\n\t});\n\treturn src;\n}\n\nfunction parse(expr) {\n\tvar m = expr.match(RX);\n\tif(m) {\n\t\tm.forEach(token=>{\n\t\t\tvar key = token.replace(/[\\$\\{\\}]/g,\"\").trim();\n\t\t\texpr = expr.replace(token,\"__val(entry,'\"+key+\"')\");\n\t\t});\n\t}\n\tvar fn = new Function(\"entry\",\"__val\",\"return (\"+expr+\")\");\n\n\treturn function(entry) {\n\t\treturn fn(entry,val);\n\t}\n}\n\nfunction tokens(expr) {\n\tif(expr==\"${JSON}\") return function(entry) {return JSON.stringify(entry,null,2)};\n\n\tvar list = [];\n\tvar m = expr.match(RX)||[];\n\tm.forEach(token=>{\n\t\tvar idx = expr.indexOf(token);\n\t\tvar t = expr.substring(0,idx);\n\t\texpr = expr.substring(idx+token.length);\n\t\tlist.push(t);\n\t\tlist.push(function(entry){\n\t\t\treturn val(entry,token.replace(/\\$|\\{|\\}/g,\"\"))\n\t\t});\n\t});\n\tlist.push(expr);\n\n\treturn function(entry) {\n\t\treturn list.map(t=>typeof(t)==\"string\"? t : t(entry)).join(\"\");\n\t}\n}\n\nfunction jsontokens(json) {\n\tlet ops = [];\n\n\tfunction walk(json,path) {\n\t\tif(!json) return;\n\t\tObject.keys(json).forEach(k=>{\n\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\n\t\t\tlet t = json[k];\n\t\t\tif(typeof(t)==\"string\") {\n\t\t\t\tops.push({path:newpath,fn:tokens(t)});\n\t\t\t}\n\t\t\telse {\n\t\t\t\twalk(t,newpath);\n\t\t\t}\n\t\t});\n\t}\n\n\twalk(json,\"\");\n\n\treturn function(entry) {\n\t\tlet map = ops.map(op=>{\n\t\t\treturn {path:op.path, value:op.fn(entry)}\n\t\t}).reduce((map,op)=>{\n\t\t\tmap[op.path] = op.value;\n\t\t\treturn map;\n\t\t},{});\n\n\t\treturn valwalk(extend(true,{},json),map,\"\");\n\t}\n}\n\nmodule.exports = {\n\tfn : parse,\n\texpr(input){\n\t\tif(typeof(input)==\"object\")\n\t\t\treturn jsontokens(input);\n\t\telse\n\t\t\treturn tokens(input);\n\t}\n}\n"]}