{"version":3,"sources":["../../../lib/expression.js"],"names":["extend","require","RX","RX_RPL_PARSE","RX_RPL_TOKEN","CACHE","cacheeval","obj","key","fn","eval","call","fneval","err","undefined","fnassign","path","EVALS","v","iteval","arr","split","forEach","ceval","valwalk","src","ops","k","newpath","rop","parse","expr","method","m","match","token","replace","trim","Function","entry","tokens","JSON","stringify","list","len","idx","indexOf","t","substring","rtoken","length","push","filter","l","ret","i","jsontokens","json","walk","Object","keys","map","op","module","exports","assign","input","expression"],"mappings":"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","file":"expression.js","sourcesContent":["const extend = require(\"extend\");\r\nconst RX = /\\$\\{[^\\}]+\\}/g;\r\nconst RX_RPL_PARSE = /[\\$\\{\\}]/g;\r\nconst RX_RPL_TOKEN = /\\$\\{|\\}/g;\r\nconst CACHE = {}\r\n\r\nfunction cacheeval(obj,key) {\r\n\tif(!CACHE[key]) {\r\n\t\tlet fn = eval(`(function(){\r\n\t\t\treturn function() {\r\n\t\t\t\ttry {\r\n\t\t\t\t\treturn this.${key};\r\n\t\t\t\t}catch(err) {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\treturn ${key};\r\n\t\t\t\t\t}catch(err) {\r\n\t\t\t\t\t\treturn undefined;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})()`);\r\n\t\tCACHE[key] = fn;\r\n\t}\r\n\treturn CACHE[key].call(obj);\r\n}\r\n\r\nfunction fneval(obj, key) {\r\n\ttry {\r\n\t\treturn eval(\"this.\" + key);\r\n\t} catch (err) {\r\n\t\treturn undefined;\r\n\t}\r\n}\r\n\r\nfunction fnassign(path) {\r\n\treturn eval(`(function(){\r\n\t\treturn function(obj,val) {\r\n\t\t\ttry {\r\n\t\t\t\treturn obj.${path} = val;\r\n\t\t\t}catch(err) {}\r\n\t\t}\r\n\t})()`);\r\n}\r\n\r\nconst EVALS = {\r\n\teval(obj,key) {\r\n\t\tlet v = fneval.call(obj,obj,key);\r\n\t\treturn v===undefined? \"\" : v;\r\n\t},\r\n\titeval(obj,key) {\r\n\t\tvar arr = key.split(\".\");\r\n\t\tarr.forEach(key=>{\r\n\t\t\tif(obj==null || obj==undefined) return;\r\n\t\t\telse obj = obj[key];\r\n\t\t});\r\n\r\n\t\tlet v = obj || undefined;\r\n\t\treturn v===undefined? \"\" : v;\r\n\t},\r\n\tceval(obj,key) {\r\n\t\tlet v = cacheeval(obj,key);\r\n\t\treturn v===undefined? \"\" : v;\r\n\t},\r\n\tvalwalk(src,ops,path) {\r\n\t\tif(!src) return src;\r\n\t\tfor(let k in src) {\r\n\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\tlet rop = ops[newpath];\r\n\t\t\tif(rop!==undefined)\r\n\t\t\t\tsrc[k] = rop;\r\n\t\t\telse if(typeof(src[k])==\"object\")\r\n\t\t\t\tEVALS.valwalk(src[k],ops,newpath);\r\n\t\t};\r\n\t\treturn src;\r\n\t}\r\n}\r\n\r\nfunction parse(expr,method) {\r\n\tmethod = method || \"ceval\";\r\n\tvar m = expr.match(RX);\r\n\tif(m) {\r\n\t\tm.forEach(token=>{\r\n\t\t\tvar key = token.replace(RX_RPL_PARSE,\"\").trim();\r\n\t\t\texpr = expr.replace(token,\"__val(entry,'\"+key+\"')\");\r\n\t\t});\r\n\t}\r\n\tvar fn = new Function(\"entry\",\"__val\",\"return (\"+expr+\")\");\r\n\r\n\treturn function(entry) {\r\n\t\treturn fn(entry,EVALS[method]);\r\n\t}\r\n}\r\n\r\nfunction tokens(expr,method) {\r\n\tmethod = EVALS[method || \"ceval\"];\r\n\tif(expr==\"${JSON}\") return function(entry) {return JSON.stringify(entry,null,2)};\r\n\r\n\tvar list = [], len = 0;\r\n\tvar m = expr.match(RX)||[];\r\n\tm.forEach(token=>{\r\n\t\tvar idx = expr.indexOf(token);\r\n\t\tvar t = expr.substring(0,idx);\r\n\t\tvar rtoken = token.replace(RX_RPL_TOKEN,\"\");\r\n\t\texpr = expr.substring(idx+token.length);\r\n\t\tlist.push(t);\r\n\t\tlist.push(function(entry){\r\n\t\t\treturn method(entry,rtoken);\r\n\t\t});\r\n\t});\r\n\tlist.push(expr);\r\n\tlist = list.filter(l=>l!=\"\");\r\n\tlen = list.length;\r\n\r\n\tif(len>1) {\r\n\t\treturn function(entry) {\r\n\t\t\tlet ret = \"\";\r\n\t\t\tfor(let i=0;i<len;i++) {\r\n\t\t\t\tlet t = list[i];\r\n\t\t\t\tret += typeof(t)==\"string\"? t : t(entry);\r\n\t\t\t}\r\n\t\t\treturn ret;\r\n\t\t}\r\n\t}\r\n\telse {\r\n\t\treturn function(entry) {\r\n\t\t\tlet t = list[0];\r\n\t\t\treturn typeof(t)==\"string\"? t : t(entry);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction jsontokens(json) {\r\n\tlet ops = [], len = 0;\r\n\r\n\tfunction walk(json,path) {\r\n\t\tif(!json) return;\r\n\t\tObject.keys(json).forEach(k=>{\r\n\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\tlet t = json[k];\r\n\t\t\tif(typeof(t)==\"string\") {\r\n\t\t\t\tops.push({path:newpath,fn:tokens(t)});\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\twalk(t,newpath);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\twalk(json,\"\");\r\n\tlen = ops.length;\r\n\r\n\treturn function(entry) {\r\n\t\tlet map = {};\r\n\t\tfor(let i=0;i<len;i++) {\r\n\t\t\tlet op = ops[i];\r\n\t\t\tmap[op.path] = op.fn(entry);\r\n\t\t}\r\n\t\treturn EVALS.valwalk(extend(true,{},json),map,\"\");\r\n\t}\r\n}\r\n\r\nmodule.exports = {\r\n\tfn : parse,\r\n\teval : parse,\r\n\tassign : fnassign,\r\n\texpr(input,replace){\r\n\t\tif(typeof(input)=='number') {\r\n\t\t\treturn function(obj){return input};\r\n\t\t}\r\n\t\telse if(typeof(input)==\"object\") {\r\n\t\t\treturn jsontokens(input,replace);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn tokens(input);\r\n\t\t}\r\n\t},\r\n\texpression(input,replace){\r\n\t\treturn typeof(input)==\"object\" ?\r\n\t\t\tjsontokens(input,replace) : tokens(input);\r\n\t},\r\n}\r\n"]}