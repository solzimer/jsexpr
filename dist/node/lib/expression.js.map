{"version":3,"sources":["../../../lib/expression.js"],"names":["extend","require","Mingo","instance","token","RX","RegExp","RX_RPL_PARSE","RX_RPL_TOKEN","RX_JSON_TOKEN","CACHE","cacheeval","obj","key","rkey","replace","rx","fn","eval","test","call","fneval","err","undefined","fnassign","path","EVALS","v","iteval","arr","split","forEach","ceval","valwalk","src","ops","k","newpath","rop","parse","expr","method","m","match","trim","Function","entry","tokens","parts","nexpr","spaces","length","isNaN","parseInt","fnxpr","JSON","stringify","list","len","idx","indexOf","t","substring","rtoken","push","filter","l","ret","i","jsontokens","json","walk","Object","keys","map","op","mingotokens","xpr","Array","isArray","$","aggr","Aggregator","input","res","run","exprfn","ninput","prfn","nxfn","prres","nxres","_","traverse","object","callback","assign","expression","module","exports"],"mappings":"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","file":"expression.js","sourcesContent":["const \r\n\textend = require(\"extend\"),\r\n\tMingo = require(\"mingo\");\r\n\r\nfunction instance(token) {\r\n\tconst RX = new RegExp(`\\\\${token}\\\\{[^\\\\}]+\\\\}`,'g');\t\t\t\t\t// /\\$\\{[^\\}]+\\}/g;\r\n\tconst RX_RPL_PARSE = new RegExp(`\\\\${token}\\\\{([^\\\\}]+)\\\\}`);\t// /\\$\\{([^\\}]+)\\}/;\r\n\tconst RX_RPL_TOKEN = new RegExp(`\\\\${token}\\\\{|\\\\}`,'g');\t\t\t\t\t// /\\$\\{|\\}/g;\r\n\tconst RX_JSON_TOKEN = new RegExp(`^\\\\${token}\\\\{JSON(:(\\\\d+|([^:]+(:(\\\\d+))?)))?\\\\}$`);\r\n\tconst CACHE = {}\r\n\r\n\tfunction cacheeval(obj,key) {\r\n\t\tif(!CACHE[key]) {\r\n\t\t\tlet rkey = key.replace(/'/g,\"\\\\'\");\r\n\t\t\tlet rx = /^[a-zA-Z$_@]/;\r\n\t\t\tlet fn = eval(`(function(){\r\n\t\t\t\tlet rx = /^[a-zA-Z$_]/;\r\n\t\t\t\treturn '${rkey}'.startsWith('this.') || '${rkey}'=='this' || !rx.test('${rkey}')?\r\n\t\t\t\t\tfunction() {\r\n\t\t\t\t\t\tlet r = undefined;\r\n\t\t\t\t\t\ttry {r=${key};}\r\n\t\t\t\t\t\tcatch(err){}\r\n\t\t\t\t\t\treturn r;\r\n\t\t\t\t\t} :\r\n\t\t\t\t\tfunction() {\r\n\t\t\t\t\t\tlet r = undefined;\r\n\t\t\t\t\t\ttry {r=this.${rx.test(key)? key:'$___$'};}\r\n\t\t\t\t\t\tcatch(err){try{r=${key};}catch(err){}}\r\n\t\t\t\t\t\treturn r;\r\n\t\t\t\t\t}\r\n\t\t\t})()`);\r\n\t\t\tCACHE[key] = fn;\r\n\t\t}\r\n\t\treturn CACHE[key].call(obj);\r\n\t}\r\n\r\n\tfunction fneval(obj, key) {\r\n\t\ttry {\r\n\t\t\treturn eval(\"this.\" + key);\r\n\t\t} catch (err) {\r\n\t\t\treturn undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction fnassign(path) {\r\n\t\treturn eval(`(function(){\r\n\t\t\treturn function(obj,val) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\treturn obj.${path} = val;\r\n\t\t\t\t}catch(err) {}\r\n\t\t\t}\r\n\t\t})()`);\r\n\t}\r\n\r\n\tconst EVALS = {\r\n\t\teval(obj,key) {\r\n\t\t\tlet v = fneval.call(obj,obj,key);\r\n\t\t\treturn v===undefined? \"\" : v;\r\n\t\t},\r\n\t\titeval(obj,key) {\r\n\t\t\tvar arr = key.split(\".\");\r\n\t\t\tarr.forEach(key=>{\r\n\t\t\t\tif(obj==null || obj==undefined) return;\r\n\t\t\t\telse obj = obj[key];\r\n\t\t\t});\r\n\r\n\t\t\tlet v = obj || undefined;\r\n\t\t\treturn v===undefined? \"\" : v;\r\n\t\t},\r\n\t\tceval(obj,key) {\r\n\t\t\tlet v = cacheeval(obj,key);\r\n\t\t\treturn v===undefined? \"\" : v;\r\n\t\t},\r\n\t\tvalwalk(src,ops,path) {\r\n\t\t\tif(!src) return src;\r\n\t\t\tfor(let k in src) {\r\n\t\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\t\tlet rop = ops[newpath];\r\n\t\t\t\tif(rop!==undefined)\r\n\t\t\t\t\tsrc[k] = rop;\r\n\t\t\t\telse if(typeof(src[k])==\"object\")\r\n\t\t\t\t\tEVALS.valwalk(src[k],ops,newpath);\r\n\t\t\t};\r\n\t\t\treturn src;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction parse(expr,method) {\r\n\t\tmethod = method || \"ceval\";\r\n\t\tvar m = expr.match(RX);\r\n\t\tif(m) {\r\n\t\t\tm.forEach(token=>{\r\n\t\t\t\tvar key = token.replace(RX_RPL_PARSE,\"$1\").trim().replace(/'/g,\"\\\\'\");\r\n\t\t\t\texpr = expr.replace(token,\"__val(entry,'\"+key+\"')\");\r\n\t\t\t});\r\n\t\t}\r\n\t\tvar fn = new Function(\"entry\",\"__val\",\"return (\"+expr+\")\");\r\n\r\n\t\treturn function(entry) {\r\n\t\t\treturn fn(entry,EVALS[method]);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction tokens(expr,method) {\r\n\t\tmethod = EVALS[method || \"ceval\"];\r\n\r\n\t\t// JSON stringify\r\n\t\tif(RX_JSON_TOKEN.test(expr)) {\r\n\t\t\tlet parts = expr.replace(RX_RPL_TOKEN,\"\").split(\":\");\r\n\t\t\tlet nexpr = parts[1];\r\n\t\t\tlet spaces = parts[2];\r\n\t\t\tif(parts.length==2) {\r\n\t\t\t\tif(isNaN(nexpr)) {spaces = 2;}\r\n\t\t\t\telse {nexpr = 'this';\tspaces = parts[1];}\r\n\t\t\t}\r\n\t\t\telse if(parts.length==1) {\r\n\t\t\t\tnexpr = 'this';\r\n\t\t\t\tspaces = 2;\r\n\t\t\t}\r\n\t\t\tspaces = parseInt(spaces);\r\n\t\t\tlet fnxpr = tokens(\"${\"+nexpr+\"}\");\r\n\t\t\treturn function(entry) {\r\n\t\t\t\treturn JSON.stringify(fnxpr(entry),null,spaces);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tvar list = [], len = 0;\r\n\t\tvar m = expr.match(RX)||[];\r\n\t\tm.forEach(token=>{\r\n\t\t\tvar idx = expr.indexOf(token);\r\n\t\t\tvar t = expr.substring(0,idx);\r\n\t\t\tvar rtoken = token.replace(RX_RPL_TOKEN,\"\");\r\n\t\t\texpr = expr.substring(idx+token.length);\r\n\t\t\tlist.push(t);\r\n\t\t\tlist.push(function(entry){\r\n\t\t\t\treturn method(entry,rtoken);\r\n\t\t\t});\r\n\t\t});\r\n\t\tlist.push(expr);\r\n\t\tlist = list.filter(l=>l!=\"\");\r\n\t\tlen = list.length;\r\n\r\n\t\tif(len>1) {\r\n\t\t\treturn function(entry) {\r\n\t\t\t\tlet ret = \"\";\r\n\t\t\t\tfor(let i=0;i<len;i++) {\r\n\t\t\t\t\tlet t = list[i];\r\n\t\t\t\t\tret += typeof(t)==\"string\"? t : t(entry);\r\n\t\t\t\t}\r\n\t\t\t\treturn ret;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn function(entry) {\r\n\t\t\t\tlet t = list[0];\r\n\t\t\t\treturn typeof(t)==\"string\"? t : t(entry);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction jsontokens(json) {\r\n\t\tlet ops = [], len = 0;\r\n\r\n\t\tfunction walk(json,path) {\r\n\t\t\tif(!json) return;\r\n\t\t\tObject.keys(json).forEach(k=>{\r\n\t\t\t\tlet newpath = `${path}${path?'.':''}${k}`;\r\n\t\t\t\tlet t = json[k];\r\n\t\t\t\tif(typeof(t)==\"string\") {\r\n\t\t\t\t\tops.push({path:newpath,fn:tokens(t)});\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\twalk(t,newpath);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\twalk(json,\"\");\r\n\t\tlen = ops.length;\r\n\r\n\t\treturn function(entry) {\r\n\t\t\tlet map = {};\r\n\t\t\tfor(let i=0;i<len;i++) {\r\n\t\t\t\tlet op = ops[i];\r\n\t\t\t\tmap[op.path] = op.fn(entry);\r\n\t\t\t}\r\n\t\t\treturn EVALS.valwalk(extend(true,{},json),map,\"\");\r\n\t\t}\r\n\t}\r\n\r\n\tfunction mingotokens(json) {\r\n\t\tlet xpr = Array.isArray(json.$)? json.$ : [json.$];\r\n\t\tlet aggr = new Mingo.Aggregator(xpr);\r\n\t\treturn function(input) {\r\n\t\t\tlet isArray = Array.isArray(input);\r\n\t\t\tlet res = aggr.run(isArray? input : [input]);\r\n\t\t\tif(!isArray && res.length<=1) return res[0];\r\n\t\t\telse return res;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction exprfn(input,replace){\r\n\t\tif(typeof(input)=='number') {\r\n\t\t\treturn function(obj){return input};\r\n\t\t}\r\n\t\telse if(typeof(input)==\"object\") {\r\n\t\t\tlet ninput = extend({},input);\r\n\t\t\tdelete ninput['$'];\r\n\r\n\t\t\tconst prfn = input[\"$\"] ? mingotokens(input, replace) : ()=>input;\r\n\t\t\tconst nxfn = Object.keys(ninput).length? jsontokens(ninput,replace) : (input)=>input;\r\n\t\t\t\r\n\t\t\treturn function(input) {\r\n\t\t\t\tlet prres = prfn(input);\r\n\t\t\t\tlet nxres = nxfn(prres);\r\n\t\t\t\tif(typeof(nxres._)!=='undefined' && Object.keys(nxres).length==1) \r\n\t\t\t\t\treturn nxres._;\r\n\t\t\t\telse\r\n\t\t\t\t\treturn nxres;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn tokens(input);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction traverse(object,callback) {\r\n\t\tfor(let key in object) {\r\n\t\t\tobject[key] = callback(object,key,object[key]);\r\n\t\t}\r\n\r\n\t\tfor(let key in object) {\r\n\t\t\tif(typeof(object[key])=='object') {\r\n\t\t\t\ttraverse(object[key],callback);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\treturn {\r\n\t\tfn : parse,\r\n\t\teval : parse,\r\n\t\tassign : fnassign,\r\n\t\texpr : exprfn,\r\n\t\texpression : exprfn,\r\n\t\ttraverse : traverse\r\n\t}\r\n}\r\n\r\nmodule.exports = instance;\r\n"]}